<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸšœ Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --p: #2e7d32; --b: #f0f2f5; }
        body { font-family: sans-serif; background: var(--b); margin: 0; padding: 10px; }
        .header { text-align: center; background: white; padding: 25px; border-radius: 12px; margin-bottom: 10px; border-bottom: 4px solid var(--p); cursor: pointer; }
        .search-box { width: 100%; padding: 12px; border-radius: 25px; border: 2px solid var(--p); margin-bottom: 15px; outline: none; box-sizing: border-box; }
        .form-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #ddd; }
        input, button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; }
        #adsContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
        .ad-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .ad-image { width: 100%; height: 140px; object-fit: cover; }
        .ad-content { padding: 10px; }
        .ad-price { color: #d32f2f; font-weight: bold; display: block; }
        .footer { text-align: center; padding: 25px; font-size: 0.9rem; color: #666; }
    </style>
</head>
<body>

    <div class="header" onclick="checkAdmin()">
        <h2 style="margin:0">ğŸšœ Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</h2>
    </div>

    <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." oninput="filterAds()">

    <div class="form-card">
        <input type="text" id="t" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
        <input type="text" id="pr" placeholder="Ø§Ù„Ø«Ù…Ù†">
        <input type="text" id="ph" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <input type="file" id="img" accept="image/*">
        <button onclick="publishAd()" id="btn">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
    </div>

    <div id="adsContainer"></div>
    <div class="footer">ØµÙ†Ø¹ ÙÙŠ ØªØ³ØªÙˆØ± â¤ï¸ Ù…Ø§Ù„Ùƒ</div>

    <script>
        const firebaseConfig = { databaseURL: "https://sou9-c7e27-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let ads = [];

        // ØªØ´ÙÙŠØ± ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ± (Ù…Ø®ÙÙŠ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹)
        const _0xM = ["\x40\x31\x35\x33\x30\x39\x30\x32\x35\x40"]; 

        async function compress(file) {
            return new Promise((res) => {
                const r = new FileReader(); r.readAsDataURL(file);
                r.onload = (e) => {
                    const i = new Image(); i.src = e.target.result;
                    i.onload = () => {
                        const c = document.createElement('canvas');
                        const w = 500; i.width > w ? (c.width = w, c.height = i.height * (w / i.width)) : (c.width = i.width, c.height = i.height);
                        const ctx = c.getContext('2d'); ctx.drawImage(i, 0, 0, c.width, c.height);
                        c.toBlob((b) => res(b), 'image/jpeg', 0.6);
                    };
                };
            });
        }

        async function publishAd() {
            const title = document.getElementById('t').value, price = document.getElementById('pr').value, phone = document.getElementById('ph').value, file = document.getElementById('img').files[0];
            if(!title || !price || !phone || !file) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
            const b = document.getElementById('btn'); b.disabled = true; b.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";
            
            try {
                const blob = await compress(file);
                const fd = new FormData(); fd.append('image', blob);
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³ÙŠØ±ÙØ± Ø±ÙØ¹ Ù…Ø®ØªÙ„Ù Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ù…Ù„
                const r = await fetch('https://api.imgbb.com/1/upload?key=67f677d3326f53e5e419842f1f531398', { method: 'POST', body: fd });
                const d = await r.json();
                if(d.success) {
                    const sec = Math.random().toString(36).substring(7).toUpperCase();
                    const ref = await db.ref('listings').push({ t: title, pr: price, p: phone, i: d.data.url, s: sec });
                    localStorage.setItem('s_'+ref.key, sec);
                    alert("âœ… ØªÙ…! ÙƒÙˆØ¯ Ø§Ù„Ø­Ø°Ù: " + sec); location.reload();
                } else throw new Error();
            } catch(e) { alert("âŒ Ø®Ø·Ø£! Ø¬Ø±Ø¨ ØµÙˆØ±Ø© Ø£Ø®Ø±Ù‰"); b.disabled = false; b.innerText = "Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"; }
        }

        db.ref('listings').on('value', s => {
            ads = []; const data = s.val();
            if(data) Object.entries(data).reverse().forEach(([id, a]) => ads.push({id, ...a}));
            render(ads);
        });

        function render(data) {
            document.getElementById('adsContainer').innerHTML = data.map(a => `
                <div class="ad-card">
                    <img src="${a.i}" class="ad-image">
                    <div class="ad-content">
                        <b>${a.t}</b><br><span class="ad-price">${a.pr}</span>
                        <small>ğŸ“ ${a.p}</small><br>
                        <button onclick="del('${a.id}','${a.s}')" style="background:#fee2e2;color:#991b1b;padding:5px;font-size:12px;margin-top:5px;border:1px solid #fecaca">Ø­Ø°Ù</button>
                    </div>
                </div>`).join('');
        }

        function filterAds() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            render(ads.filter(a => a.t.toLowerCase().includes(term)));
        }

        function del(id, s) {
            const p = prompt("ÙƒÙˆØ¯ Ø§Ù„Ø­Ø°Ù Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ±:");
            if(p === s || p === _0xM[0]) db.ref('listings/'+id).remove();
        }

        function checkAdmin() {
            const p = prompt("ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±:");
            if(p === _0xM[0]) alert("ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª: " + ads.length);
        }
    </script>
</body>
</html>
