<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸšœ Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
:root { --p:#2e7d32; --b:#f0f2f5; --w:#25d366; }
body { font-family:sans-serif; background:var(--b); margin:0; padding:10px; }
.header { text-align:center; background:white; padding:20px; border-radius:12px; margin-bottom:10px; border-bottom:4px solid var(--p); cursor:pointer; }
.search-box { width:100%; padding:12px; border-radius:25px; border:2px solid var(--p); margin-bottom:15px; outline:none; box-sizing:border-box; }
.form-card { background:white; padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid #ddd; }
input, button { width:100%; padding:12px; margin:5px 0; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; }
.btn-pub { background:var(--p); color:white; border:none; font-weight:bold; cursor:pointer; }
#adsContainer { display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:10px; }
.ad-card { background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); text-align:center; display:flex; flex-direction:column; }
.ad-image { width:100%; height:140px; object-fit:cover; }
.ad-content { padding:10px; flex-grow:1; }
.ad-title { font-weight:bold; display:block; margin-bottom:2px; }
.ad-price { color:#d32f2f; font-weight:bold; display:block; font-size:1.1rem; }
.contact-btns { display:flex; gap:5px; margin-top:10px; }
.btn-call { background:var(--p); color:white; text-decoration:none; flex:1; padding:8px; border-radius:5px; font-size:0.8rem; font-weight:bold; }
.btn-wa { background:var(--w); color:white; text-decoration:none; flex:1; padding:8px; border-radius:5px; font-size:0.8rem; font-weight:bold; }
.btn-del { background:#fee2e2; color:#991b1b; border:1px solid #fecaca; width:100%; margin-top:8px; padding:5px; border-radius:5px; font-size:0.7rem; cursor:pointer; }
.footer { text-align:center; padding:25px; font-size:0.9rem; color:#666; }
</style>
</head>
<body>

<div class="header" onclick="checkAdmin()">
<h2 style="margin:0">ğŸšœ Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</h2>
</div>

<input type="text" id="searchInput" class="search-box" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." oninput="filterAds()">

<div class="form-card">
<input type="text" id="t" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
<input type="text" id="pr" placeholder="Ø§Ù„Ø«Ù…Ù†">
<input type="text" id="ph" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
<input type="file" id="img" accept="image/*">
<button onclick="publishAd()" id="btn" class="btn-pub">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
</div>

<div id="adsContainer"></div>
<div class="footer">ØµÙ†Ø¹ Ø¨ÙƒÙ„ ÙØ®Ø± ÙÙŠ ØªØ³ØªÙˆØ± â¤ï¸ Ù…Ø§Ù„Ùƒ 2026</div>

<script>
const firebaseConfig = { databaseURL: "https://sou9-c7e27-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let ads = [];

const _0xM = ["\x40\x31\x35\x33\x30\x39\x30\x32\x35\x40"]; 

async function compress(file) {
    return new Promise(res => {
        const reader = new FileReader(); reader.readAsDataURL(file);
        reader.onload = e => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const maxWidth = 500;
                if(img.width > maxWidth){ canvas.width = maxWidth; canvas.height = img.height * (maxWidth / img.width); }
                else { canvas.width = img.width; canvas.height = img.height; }
                canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
                canvas.toBlob(blob => res(blob),'image/jpeg',0.6);
            }
        }
    });
}

async function publishAd() {
    const title = document.getElementById('t').value, price = document.getElementById('pr').value, phone = document.getElementById('ph').value, file = document.getElementById('img').files[0];
    if(!title || !price || !phone || !file) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
    
    const b = document.getElementById('btn'); b.disabled=true; b.innerText="â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";

    try {
        const blob = await compress(file);
        const fd = new FormData(); fd.append('image', blob);
        const res = await fetch('https://api.imgbb.com/1/upload?key=095fed96bdc0302b815406d636818189',{ method:'POST', body:fd });
        const data = await res.json();

        if(data.success){
            const sec = Math.random().toString(36).substring(7).toUpperCase();
            const adRef = await db.ref('listings').push({ t:title, pr:price, p:phone, i:data.data.url, s:sec, d:Date.now() });
            
            // Ø­ÙØ¸ ÙƒÙˆØ¯ Ø§Ù„Ø­Ø°Ù ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù‡Ø§ØªÙ Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ù„Ø¶Ù…Ø§Ù† Ø¨Ù‚Ø§Ø¦Ù‡
            localStorage.setItem('my_code_' + adRef.key, sec);
            
            alert("âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ”‘ ÙƒÙˆØ¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ: " + sec);
            location.reload();
        } else throw new Error();
    } catch(e) { alert("âŒ Ø®Ø·Ø£! Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."); b.disabled=false; b.innerText="Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"; }
}

db.ref('listings').on('value', s=>{
    ads=[]; const data = s.val();
    if(data) Object.entries(data).reverse().forEach(([id,a])=>ads.push({id,...a}));
    renderAds(ads);
});

function renderAds(data){
    document.getElementById('adsContainer').innerHTML = data.map(a=>`
    <div class="ad-card">
        <img src="${a.i}" class="ad-image">
        <div class="ad-content">
            <span class="ad-title">${a.t}</span>
            <span class="ad-price">Ø§Ù„Ø³Ø¹Ø±: ${a.pr}</span>
            <div class="contact-btns">
                <a href="tel:${a.p}" class="btn-call">ğŸ“ Ø§ØªØµØ§Ù„</a>
                <a href="https://wa.me/216${a.p}" class="btn-wa">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</a>
            </div>
            <button onclick="delAd('${a.id}','${a.s}')" class="btn-del">Ø­Ø°Ù</button>
        </div>
    </div>`).join('');
}

function filterAds(){
    const term = document.getElementById('searchInput').value.toLowerCase();
    renderAds(ads.filter(a=>a.t.toLowerCase().includes(term)));
}

function delAd(id, serverCode){
    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† Ù…Ù† Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ¥Ø¸Ù‡Ø§Ø±Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    const savedCode = localStorage.getItem('my_code_' + id) || "";
    
    // Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¢Ù† Ø³ÙŠØ¸Ù‡Ø± ÙˆÙÙŠÙ‡ Ø§Ù„ÙƒÙˆØ¯ Ù…ÙƒØªÙˆØ¨Ø§Ù‹ Ø¬Ø§Ù‡Ø²Ø§Ù‹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const input = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø­Ø°Ù:", savedCode);
    
    if(input === serverCode || input === _0xM[0]) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ")) {
            db.ref('listings/'+id).remove();
            localStorage.removeItem('my_code_' + id); // Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
        }
    } else if(input !== null) {
        alert("âŒ Ø§Ù„ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦");
    }
}

function checkAdmin(){
    const input = prompt("ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±:");
    if(input===_0xM[0]) alert("ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: " + ads.length + " Ø¥Ø¹Ù„Ø§Ù† Ø­Ø§Ù„ÙŠØ§Ù‹");
}
</script>
</body>
</html>
