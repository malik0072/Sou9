<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸšœ Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
:root { --p:#2e7d32; --b:#f0f2f5; }
body { font-family:sans-serif; background:var(--b); margin:0; padding:10px; }
.header { text-align:center; background:white; padding:25px; border-radius:12px; margin-bottom:10px; border-bottom:4px solid var(--p); cursor:pointer; }
.search-box { width:100%; padding:12px; border-radius:25px; border:2px solid var(--p); margin-bottom:15px; outline:none; box-sizing:border-box; }
.form-card { background:white; padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid #ddd; }
input, button { width:100%; padding:12px; margin:5px 0; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; }
button { background:var(--p); color:white; border:none; font-weight:bold; cursor:pointer; }
#adsContainer { display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:10px; }
.ad-card { background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); text-align:center; }
.ad-image { width:100%; height:140px; object-fit:cover; }
.ad-content { padding:10px; }
.ad-price { color:#d32f2f; font-weight:bold; display:block; }
.footer { text-align:center; padding:25px; font-size:0.9rem; color:#666; }
</style>
</head>
<body>

<div class="header" onclick="checkAdmin()">
<h2 style="margin:0">ğŸšœ Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</h2>
</div>

<input type="text" id="searchInput" class="search-box" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." oninput="filterAds()">

<div class="form-card">
<input type="text" id="t" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
<input type="text" id="pr" placeholder="Ø§Ù„Ø«Ù…Ù†">
<input type="text" id="ph" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
<input type="file" id="img" accept="image/*">
<button onclick="publishAd()" id="btn">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
</div>

<div id="adsContainer"></div>
<div class="footer">ØµÙ†Ø¹ ÙÙŠ ØªØ³ØªÙˆØ± â¤ï¸ Ù…Ø§Ù„Ùƒ</div>

<script>
const firebaseConfig = { databaseURL: "https://sou9-c7e27-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let ads = [];

// ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ± Ù…Ø®ÙÙŠ
const ADMIN_CODE = "@15309025@";

async function compress(file) {
    return new Promise(res => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const maxWidth = 500;
                if(img.width > maxWidth) {
                    canvas.width = maxWidth;
                    canvas.height = img.height * (maxWidth / img.width);
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                }
                canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
                canvas.toBlob(blob => res(blob), 'image/jpeg', 0.6);
            }
        }
    });
}

async function publishAd() {
    const title = document.getElementById('t').value;
    const price = document.getElementById('pr').value;
    const phone = document.getElementById('ph').value;
    const file = document.getElementById('img').files[0];
    if(!title || !price || !phone || !file) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");

    const btn = document.getElementById('btn');
    btn.disabled = true; btn.innerText="â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";

    try {
        const blob = await compress(file);
        const fd = new FormData();
        fd.append('image', blob);
        const res = await fetch('https://api.imgbb.com/1/upload?key=67f677d3326f53e5e419842f1f531398', { method:'POST', body:fd });
        const data = await res.json();
        if(data.success){
            const deleteCode = Math.random().toString(36).substring(7).toUpperCase();
            const ref = await db.ref('listings').push({ t:title, pr:price, p:phone, i:data.data.url, s:deleteCode });
            localStorage.setItem('s_'+ref.key, deleteCode);
            alert("âœ… ØªÙ…! ÙƒÙˆØ¯ Ø§Ù„Ø­Ø°Ù: "+deleteCode);
            location.reload();
        } else throw new Error();
    } catch(e){ alert("âŒ Ø®Ø·Ø£! Ø¬Ø±Ø¨ ØµÙˆØ±Ø© Ø£Ø®Ø±Ù‰"); btn.disabled=false; btn.innerText="Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"; }
}

db.ref('listings').on('value', snapshot => {
    ads=[];
    const data = snapshot.val();
    if(data) Object.entries(data).reverse().forEach(([id,a])=>ads.push({id,...a}));
    renderAds(ads);
});

function renderAds(data){
    document.getElementById('adsContainer').innerHTML = data.map(a=>`
    <div class="ad-card">
        <img src="${a.i}" class="ad-image">
        <div class="ad-content">
            <b>${a.t}</b><br><span class="ad-price">${a.pr}</span>
            <small>ğŸ“ ${a.p}</small><br>
            <button onclick="delAd('${a.id}','${a.s}')" style="background:#fee2e2;color:#991b1b;padding:5px;font-size:12px;margin-top:5px;border:1px solid #fecaca">Ø­Ø°Ù</button>
        </div>
    </div>`).join('');
}

function filterAds(){
    const term = document.getElementById('searchInput').value.toLowerCase();
    renderAds(ads.filter(a=>a.t.toLowerCase().includes(term)));
}

function delAd(id, code){
    const input = prompt("ÙƒÙˆØ¯ Ø§Ù„Ø­Ø°Ù Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ±:");
    if(input === code || input === ADMIN_CODE) db.ref('listings/'+id).remove();
}

function checkAdmin(){
    const input = prompt("ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±:");
    if(input === ADMIN_CODE) alert("ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª: "+ads.length);
}
</script>
</body>
</html>
